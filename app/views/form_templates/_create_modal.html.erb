<div id="create-form-modal"
     class="modal form-builder-modal"
     data-controller="form-builder"
     data-form-builder-acl-groups-value="<%= acl_groups.to_json %>"
     data-form-builder-employees-value="<%= employees.to_json %>"
     style="display: none;">
  
  <div class="form-builder-modal-content">
    <div class="modal-header">
      <h2>Create New Form</h2>
      <button type="button" 
              class="close-modal" 
              data-action="click->form-builder#closeModal">&times;</button>
    </div>
    
  <%= form_with model: FormTemplate.new, 
                url: form_templates_path, 
                method: :post,
                  data: { 
                    form_builder_target: "form",
                    action: "submit->form-builder#submitForm"
                  } do |f| %>
      
      <div class="modal-body">
        <!-- Step 1: Form Name -->
        <div class="form-group">
          <label for="form_name">1. Name of Form <span class="required">*</span></label>
          <%= f.text_field :name, 
                          id: "form_name",
                          class: "form-control",
                          placeholder: "e.g., Authorization Request",
                          required: true,
                          data: { form_builder_target: "formName" } %>
        </div>
        
        <!-- Step 2: Access Level -->
        <div class="form-group">
          <label for="form_access">2. Access <span class="required">*</span></label>
          <%= f.select :access_level,
                      options_for_select([['Public', 'public'], ['Restricted', 'restricted']]),
                      {},
                      {
                        id: "form_access",
                        class: "form-control",
                        data: { 
                          form_builder_target: "accessLevel",
                          action: "change->form-builder#toggleACLGroup"
                        }
                      } %>
        </div>
        
        <!-- Step 3: ACL Group (hidden by default) -->
        <div class="form-group" 
             data-form-builder-target="aclGroupContainer"
             style="display: none;">
          <label for="form_acl_group">3. ACL Group <span class="required">*</span></label>
          <%= f.select :acl_group_id,
                      options_for_select(acl_groups),
                      { include_blank: "Select a group..." },
                      {
                        id: "form_acl_group",
                        class: "form-control",
                        data: { form_builder_target: "aclGroup" }
                      } %>
        </div>
        
        <!-- Step 4: Number of Pages -->
        <div class="form-group">
          <label for="form_page_count">4. Number of Pages <span class="required">*</span></label>
          <%= f.number_field :page_count,
                            id: "form_page_count",
                            class: "form-control",
                            min: 2,
                            max: 30,
                            value: 2,
                            data: { 
                              form_builder_target: "pageCount",
                              action: "change->form-builder#updatePageHeaders"
                            } %>
          <small class="form-text">Minimum: 2 (Employee Info, Agency Info) | Maximum: 30</small>
        </div>
        
        <!-- Additional Page Headers (shown when pages > 2) -->
        <div class="form-group page-headers-container"
             data-form-builder-target="pageHeadersContainer"
             style="display: none;">
          <label>Page Names (for pages 3+)</label>
          <div data-form-builder-target="pageHeadersList"></div>
        </div>

        <!-- Step 5: Submission Routing -->
        <div class="form-group">
          <label for="form_submission_type">5. Form Submission Routing <span class="required">*</span></label>
          <%= f.select :submission_type,
                      options_for_select([
                        ['Submit to Database (Ends the workflow)', 'database'],
                        ['Routed for Approval', 'approval']
                      ], 'database'),
                      {},
                      {
                        id: "form_submission_type",
                        class: "form-control",
                        data: {
                          form_builder_target: "submissionType",
                          action: "change->form-builder#toggleApprovalRouting"
                        }
                      } %>
        </div>

        <!-- Approval Routing Steps (hidden by default) -->
        <div class="form-group"
             data-form-builder-target="approvalRoutingContainer"
             style="display: none;">
          <label>Routing Steps <span class="required">*</span></label>
          <small class="form-text" style="display: block; margin-bottom: 10px;">
            Add one or more routing steps. Forms will be routed through each step in order.
          </small>
          <div class="routing-steps-container" data-form-builder-target="routingStepsContainer">
            <!-- Routing steps will be added here dynamically -->
          </div>
          <button type="button"
                  class="btn btn-secondary btn-sm"
                  data-action="click->form-builder#addRoutingStep">
            + Add Routing Step
          </button>
        </div>

        <!-- Step 6: Inbox Queue Buttons -->
        <div class="form-group">
          <label>6. Inbox Queue Buttons</label>
          <small class="form-text" style="display: block; margin-bottom: 10px;">
            Select which action buttons should appear in the inbox queue for this form type.
          </small>
          <div class="inbox-buttons-container" style="display: flex; flex-wrap: wrap; gap: 15px;">
            <% FormTemplate::INBOX_BUTTON_TYPES.each do |key, config| %>
              <div class="inbox-button-option" style="flex: 0 0 calc(50% - 10px); display: flex; align-items: flex-start; gap: 8px;">
                <input type="checkbox"
                       name="form_template[inbox_buttons][]"
                       value="<%= key %>"
                       id="inbox_button_<%= key %>"
                       style="margin-top: 3px;"
                       <%= 'checked' if %w[view_pdf].include?(key) %>>
                <label for="inbox_button_<%= key %>" style="margin: 0; cursor: pointer;">
                  <strong><%= config[:label] %></strong>
                  <small style="display: block; color: #6c757d; font-weight: normal;"><%= config[:description] %></small>
                </label>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Step 7: Fields -->
        <div class="form-group">
          <label>7. Fields</label>
          <small class="form-text" style="display: block; margin-bottom: 10px;">
            Add custom fields for your form. <strong>Tip:</strong> Drag the &#x2630; handle to reorder fields.
          </small>
          <div class="fields-container" data-form-builder-target="fieldsContainer">
            <!-- Fields will be added here dynamically -->
          </div>
          <button type="button"
                  class="btn btn-secondary btn-sm"
                  data-action="click->form-builder#addField">
            + Add Field
          </button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-secondary" 
                data-action="click->form-builder#closeModal">
          Cancel
        </button>
        <%= f.submit "Create Form Template", 
                    class: "btn btn-primary",
                    data: { form_builder_target: "submitButton" } %>
      </div>
    <% end %>
  </div>
</div>

<!-- Field Template (hidden, used for cloning) -->
<template id="field-template">
  <div class="field-item" data-form-builder-target="fieldItem">
    <div class="field-row">
      <div class="drag-handle" title="Drag to reorder">
        <span class="field-position">#1</span>
        <span class="drag-icon">&#x2630;</span>
      </div>

      <div class="field-input">
        <label>Label</label>
        <input type="text"
               name="fields[][label]"
               class="form-control form-control-sm"
               placeholder="e.g., Employee Name"
               required>
      </div>

      <div class="field-input">
        <label>Type</label>
        <select name="fields[][field_type]"
                class="form-control form-control-sm"
                data-action="change->form-builder#handleFieldTypeChange"
                required>
          <option value="text">Text</option>
          <option value="text_box">Text Box</option>
          <option value="dropdown">Dropdown</option>
        </select>
      </div>

      <div class="field-input">
        <label>Page</label>
        <select name="fields[][page_number]"
                class="form-control form-control-sm page-select"
                required>
          <option value="1">Page 1 - Employee Info</option>
          <option value="2">Page 2 - Agency Info</option>
        </select>
      </div>

      <div class="field-input">
        <label>Required?</label>
        <input type="checkbox"
               name="fields[][required]"
               value="1">
      </div>

      <button type="button"
              class="btn btn-danger btn-sm"
              data-action="click->form-builder#removeField">
        Remove
      </button>
    </div>

    <!-- Field Restriction Options -->
    <div class="field-options field-restriction-options" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
      <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <label style="margin: 0; font-size: 0.85em; color: #495057;">Fill out by:</label>
        <select name="fields[][restricted_to_type]"
                class="form-control form-control-sm restriction-type-select"
                data-action="change->form-builder#toggleFieldRestriction"
                style="width: auto; min-width: 150px;">
          <option value="none">Anyone (Submitter)</option>
          <option value="employee">Specific Employee</option>
          <option value="group">Group</option>
        </select>

        <div class="restriction-employee-select" style="display: none;">
          <select name="fields[][restricted_to_employee_id]"
                  class="form-control form-control-sm restriction-employee-dropdown"
                  style="min-width: 200px;">
            <option value="">Select employee...</option>
          </select>
        </div>

        <div class="restriction-group-select" style="display: none;">
          <select name="fields[][restricted_to_group_id]"
                  class="form-control form-control-sm restriction-group-dropdown"
                  style="min-width: 200px;">
            <option value="">Select group...</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Text Box Options -->
    <div class="field-options text-box-options" style="display: none;">
      <label>Rows:</label>
      <input type="number"
             name="fields[][rows]"
             class="form-control form-control-sm"
             value="5"
             min="1"
             max="20">
    </div>

    <!-- Dropdown Options -->
    <div class="field-options dropdown-options" style="display: none;">
      <label>Values (comma-separated):</label>
      <input type="text"
             name="fields[][dropdown_values]"
             class="form-control form-control-sm"
             placeholder="Option 1, Option 2, Option 3">
    </div>
  </div>
</template>

<!-- Routing Step Template (hidden, used for cloning) -->
<template id="routing-step-template">
  <div class="routing-step-item" data-form-builder-target="routingStepItem" style="background: #f0f4f8; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid #007bff;">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <span class="step-number" style="font-weight: bold; color: #495057; min-width: 60px;">Step 1:</span>

      <div style="flex: 1; min-width: 150px;">
        <select name="routing_steps[][routing_type]"
                class="form-control form-control-sm routing-type-select"
                data-action="change->form-builder#toggleStepEmployeeSelect"
                required>
          <option value="">Select...</option>
          <option value="supervisor">Supervisor</option>
          <option value="department_head">Department Head</option>
          <option value="employee">Specific Employee</option>
        </select>
      </div>

      <div class="step-employee-select" style="flex: 1; min-width: 200px; display: none;">
        <select name="routing_steps[][employee_id]"
                class="form-control form-control-sm step-employee-dropdown">
          <option value="">Select employee...</option>
        </select>
      </div>

      <input type="hidden" name="routing_steps[][step_number]" class="step-number-input" value="1">

      <button type="button"
              class="btn btn-danger btn-sm"
              data-action="click->form-builder#removeRoutingStep"
              style="padding: 4px 8px;">
        Remove
      </button>
    </div>
  </div>
</template>
