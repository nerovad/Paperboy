<%# app/views/shared/_sidebar.html.erb %>
<button class="hamburger-btn" data-controller="sidebar" data-action="click->sidebar#toggle">
  <span class="navbar-toggler-icon"></span>
</button>

<!-- Overlay -->
<div class="sidebar-overlay" data-controller="sidebar" data-action="click->sidebar#close"></div>

<div class="sidebar" data-controller="sidebar-search">
  <h2>Available Forms</h2>
  <% if current_user %>
    <input
      type="text"
      placeholder="Search forms, fields, tags..."
      data-sidebar-search-target="input"
      data-action="input->sidebar-search#filter"
      class="sidebar-search-input"
    />
    <% 
    # Legacy forms not managed via FormTemplate
    public_forms = [
      ["Creative Job Request", new_creative_job_request_path],
    ]
    public_forms.unshift(["Billing Tools", new_billing_tool_path]) if system_admin?

    # Build available forms list
    available_forms = public_forms.dup

    # Cache form templates with their field labels and tags for search
    form_field_labels = {}
    form_tags = {}
    FormTemplate.includes(:form_fields).each do |template|
      form_field_labels[template.name] = template.form_fields.pluck(:label).join(", ")
      form_tags[template.name] = template.tags_array.join(", ")
    end

    # Resolve the route path for a FormTemplate.
    # Tries the standard _form convention first, then falls back
    # to the base name for legacy forms (e.g. critical_information_reportings).
    resolve_path = ->(template) {
      begin
        send("new_#{template.file_name}_path")
      rescue NoMethodError
        send("new_#{template.file_name.chomp('_form')}_path") rescue nil
      end
    }

    # Add public templates not already in hardcoded list
    FormTemplate.where(access_level: 'public').each do |template|
      path = resolve_path.call(template)
      next unless path
      next if public_forms.any? { |f| f[0] == template.name }
      available_forms << [template.name, path]
    end

    # Add restricted templates the current user can access (system admins see all)
    FormTemplate.where(access_level: 'restricted').each do |template|
      next unless system_admin? || template.accessible_by?(current_user_org_chain, current_user_group_ids)
      path = resolve_path.call(template)
      available_forms << [template.name, path] if path
    end
    %>
    <div data-sidebar-search-target="formsList">
      <% available_forms.sort_by { |f| f[0] }.each do |label, path| %>
        <%= link_to label, path, class: "nav-link",
            data: {
              turbo_frame: "main-content",
              sidebar_search_target: "formLink",
              fields: form_field_labels[label] || "",
              tags: form_tags[label] || ""
            } %>
      <% end %>
    </div>
    
  <% else %>
    <p class="sidebar-p">Please log in to access forms.</p>
  <% end %>
</div>
