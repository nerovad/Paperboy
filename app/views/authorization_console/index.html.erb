<!-- app/views/authorization_console/index.html.erb -->
<div class="form-header">
  <h1>Authorization Console</h1>
</div>

<div class="form-wrapper authorization-console" data-controller="confirm-modal">
  <% if @managed_departments.size > 1 %>
    <div class="department-selector">
      <label>Select Department:</label>
      <%= form_with url: authorization_console_index_path, method: :get, data: { turbo: false, controller: "auto-submit" } do %>
        <%= select_tag :department_id,
              options_for_select(
                @managed_departments.map { |d| ["#{d.department_id} - #{d.long_name}", d.department_id] },
                @department_id.to_s
              ),
              class: "form-control",
              data: { action: "change->auto-submit#submit" } %>
      <% end %>
    </div>
  <% end %>

  <% if @department %>
    <div class="department-header">
      <h2><%= @department.long_name %> (<%= @department.department_id %>)</h2>
      <%= link_to "+ Add New Authorized Approver",
            new_authorization_console_path(department_id: @department_id),
            class: "btn approve" %>
    </div>
    
    <% if @approvers_by_employee.any? %>
      <div class="approvers-list">
        <% @approvers_by_employee.each do |employee_id, approvals| %>
          <div class="approver-card">
            <div class="approver-header">
              <h3>
                <%= approvals.first.employee&.First_Name %> <%= approvals.first.employee&.Last_Name %>
                <span class="employee-id">(<%= employee_id %>)</span>
              </h3>
            </div>
            
            <div class="approvals-list">
              <% approvals.each do |approval| %>
                <div class="approval-item">
                  <div class="approval-details">
                    <strong><%= approval.service_type_label %> (<%= approval.service_type %>)</strong>
                    
                    <% if approval.service_type == 'K' && approval.key_type.present? %>
                      <div class="detail-row">
                        <span class="label">Key Type:</span>
                        <span class="value"><%= approval.key_type_label %></span>
                      </div>
                    <% end %>
                    
                    <% if approval.span.present? %>
                      <div class="detail-row">
                        <span class="label">Scope:</span>
                        <span class="value"><%= approval.span_label %></span>
                      </div>
                    <% end %>
                    
                    <% if approval.budget_units.present? %>
                      <div class="detail-row">
                        <span class="label">Budget Units:</span>
                        <span class="value"><%= approval.budget_units %></span>
                      </div>
                    <% end %>
                    
                    <% if approval.locations.present? %>
                      <div class="detail-row">
                        <span class="label">Locations:</span>
                        <span class="value"><%= approval.locations %></span>
                      </div>
                    <% end %>
                  </div>
                  
                  <div class="approval-actions">
                    <%= link_to "Edit", edit_authorization_console_path(approval), class: "btn" %>
                    <button type="button"
                            class="btn deny"
                            data-action="click->confirm-modal#open"
                            data-delete-path="<%= authorization_console_path(approval) %>"
                            data-confirm-title="Remove Authorization"
                            data-confirm-message="Are you sure you want to remove the authorization for <%= approval.service_type_label %> from <%= approvals.first.employee&.First_Name %> <%= approvals.first.employee&.Last_Name %>?">
                      Remove
                    </button>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="empty-state">
        <p>No authorized approvers have been assigned for this department yet.</p>
        <p class="empty-state-hint">Click "+ Add New Authorized Approver" to get started.</p>
      </div>
    <% end %>
  <% else %>
    <div class="empty-state">
      <p>No departments assigned to manage.</p>
    </div>
  <% end %>
  <%= render "shared/confirm_modal" %>
</div>
