<!-- app/views/authorization_console/new.html.erb -->
<div class="form-header">
  <h1>Add Authorized Approver</h1>
</div>

<div class="form-wrapper authorization-console">
  <%= form_with model: @authorized_approver, url: authorization_console_index_path, local: true do |form| %>
    <% if @authorized_approver.errors.any? %>
      <div class="alert alert-danger">
        <p><strong>There was a problem:</strong></p>
        <ul>
          <% @authorized_approver.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%= form.hidden_field :department_id, value: @department_id %>

    <div class="form-group">
      <%= form.label :employee_id, "Employee" %>
      <%= form.select :employee_id,
            options_for_select(@department_employees.map { |e| [e[:name], e[:id]] }, @authorized_approver.employee_id),
            { prompt: "Select Employee" },
            class: "form-control",
            required: true %>
    </div>

    <!-- Wrap all key-related fields under one Stimulus controller -->
    <div data-controller="authorization-select">
      <div class="form-group">
        <%= form.label :service_type, "Service Type" %>
        <%= form.select :service_type,
              options_for_select(AuthorizedApprover::SERVICE_TYPES.map { |k, v| ["#{v} (#{k})", k] }, @authorized_approver.service_type),
              { prompt: "Select Service Type" },
              class: "form-control",
              required: true,
              data: {
                authorization_select_target: "serviceType",
                action: "change->authorization-select#toggleFields"
              } %>
      </div>

      <div class="form-group"
           data-authorization-select-target="keyTypeWrapper"
           style="display:none;">
        <%= form.label :key_type, "Key Type" %>
        <%= form.select :key_type,
              options_for_select(AuthorizedApprover::KEY_TYPES.map { |k, v| ["#{k} = #{v}", k] }, @authorized_approver.key_type),
              { prompt: "Select Key Type" },
              class: "form-control",
              data: { authorization_select_target: "keyType" } %>
      </div>

      <div class="form-group"
          data-authorization-select-target="locationsWrapper"
          data-controller="choices"
          style="display:none;">
        <%= form.label :locations, "Building Locations" %>

        <%= form.select :locations,
              options_for_select(
                (@building_options || []),
                @authorized_approver.locations&.split(",")
              ),
              {},
              multiple: true,
              class: "form-control",
              data: {
                authorization_select_target: "locations",
                choices_target: "select",                 # ðŸ‘ˆ tell Stimulus this is the select
                placeholder: "Select building(s)â€¦"
              } %>

        <small class="help-text">
          Leave blank to allow all locations
        </small>
      </div>
    </div>

    <div class="form-group">
      <%= form.label :span, "Authorization Span" %>
      <%= form.select :span,
            options_for_select(AuthorizedApprover::SPANS.map { |k, v| ["#{k} = #{v}", k] }, @authorized_approver.span),
            { prompt: "Select Span" },
            class: "form-control" %>
    </div>

    <div class="form-group" data-controller="choices">
      <%= form.label :budget_units, "Budget Units" %>

      <%= form.select :budget_units,
            options_for_select(
              (@budget_unit_options || []),
              @authorized_approver.budget_units&.split(",")
            ),
            {},
            multiple: true,
            class: "form-control",
            data: {
              choices_target: "select",
              placeholder: "Select budget unit(s)â€¦"
            } %>

      <small class="help-text">
        Leave blank to allow all budget units
      </small>
    </div>

    <div class="form-actions">
      <%= link_to "Cancel",
                  authorization_console_index_path(department_id: @department_id),
                  class: "btn" %>
      <%= form.submit "Add Authorization", class: "btn approve" %>
    </div>
  <% end %>
</div>
