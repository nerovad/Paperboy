<!-- app/views/inbox/queue.html.erb -->
<turbo-frame id="main-content" data-controller="approve-modal deny-modal parking-approve-modal">
  <h1 class="page-title">Inbox Queue</h1>

  <div class="table-wrapper">
    <table class="submission-table">
      <thead>
        <tr>
          <th>Form Type</th>
          <th>Name</th>
          <th>Unit</th>
          <th>Email</th>
          <th>Stage</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% if @submissions.present? %>
          <% @submissions.each do |submission| %>
            <tr>
              <td><%= submission.class.name.demodulize.titleize %></td>
              <td><%= submission.name %></td>
              <td><%= submission.try(:unit) || "—" %></td>
              <td><%= submission.email %></td>
              <td>
                <span class="badge <%= status_badge_class(submission.status_label) %>">
                  <%= submission.status_label.to_s.tr('_', ' ').titleize %>
                </span>
              </td>

              <td class="action-buttons">
              <div class="button-container">
                <% if submission.is_a?(ParkingLotSubmission) %>
                  <%= link_to "View PDF", pdf_parking_lot_submission_path(submission), target: "_blank", class: "btn pdf" %>
                  
                  <% if submission.submitted? %>
                    <button type="button"
                            class="btn approve"
                            data-action="click->parking-approve-modal#open"
                            data-parking-approve-modal-submission-id-value="<%= submission.id %>"
                            data-parking-approve-modal-approve-path-value="<%= polymorphic_path(submission, action: :approve) %>"
                            data-parking-approve-modal-employees-value="<%= @department_employees[submission.id].to_json %>">
                      Approve & Delegate
                    </button>
                  <% elsif submission.pending_delegated_approval? %>
                    <%= button_to "Final Approve",
                          polymorphic_path(submission, action: :approve),
                          method: :patch, class: "btn approve" %>
                  <% end %>

                  <!-- app/views/inbox/queue.html.erb -->
                <% elsif submission.is_a?(AuthorizationForm) %>
                  <%= link_to "View PDF", pdf_authorization_form_path(submission), target: "_blank", class: "btn pdf" %>
                  
                  <% if submission.submitted? %>
                    <!-- Dept Head Approval - needs delegated approver selection -->
                    <button type="button"
                            class="btn approve"
                            data-action="click->parking-approve-modal#open"
                            data-parking-approve-modal-submission-id-value="<%= submission.id %>"
                            data-parking-approve-modal-approve-path-value="<%= polymorphic_path(submission, action: :approve) %>"
                            data-parking-approve-modal-employees-value="<%= @department_employees[submission.id].to_json %>">
                      Approve & Delegate
                    </button>
                  <% elsif submission.pending_delegated_approval? %>
                    <!-- Delegated Approver - simple approval -->
                    <%= button_to "Final Approve",
                          polymorphic_path(submission, action: :approve),
                          method: :patch, class: "btn approve" %>
                  <% end %>

                <% elsif submission.is_a?(ProbationTransferRequest) %>
                  <%= link_to "View PDF", pdf_probation_transfer_request_path(submission), target: "_blank", class: "btn pdf" %>
                  <button type="button"
                          class="btn approve"
                          data-action="click->approve-modal#open"
                          data-approve-modal-approve-path-value="<%= polymorphic_path(submission, action: :approve) %>"
                          data-approve-modal-options-value="<%= submission.desired_destinations_array.to_json %>"
                          data-approve-modal-title-value="<%= "Approve Transfer ##{submission.id}" %>">
                    Approve
                  </button>
                <% end %>

                <button type="button"
                        class="btn deny"
                        data-action="click->deny-modal#open"
                        data-deny-path="<%= polymorphic_path(submission, action: :deny) %>"
                        data-record-title="<%= "#{submission.class.name.demodulize.titleize} ##{submission.id}" %>">
                  Deny
                </button>
              </div>
            </td>
            </tr>
          <% end %>
        <% else %>
          <tr><td colspan="6">No submissions found.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Parking Approve Modal (NEW) -->
  <div id="parking-approve-modal-backdrop"
       class="deny-modal-backdrop"
       data-parking-approve-modal-target="backdrop"
       style="display:none;">
    <div class="deny-modal" role="dialog" aria-modal="true" data-parking-approve-modal-target="modal">
      <div class="deny-modal__header">
        <h3>Approve & Select Delegated Approver</h3>
        <button type="button" class="deny-modal__close" data-action="parking-approve-modal#close" aria-label="Close">✕</button>
      </div>
      <div class="deny-modal__body">
        <p>Select an employee from this department to perform the final approval:</p>
        <form data-parking-approve-modal-target="form" method="post" action="#">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :_method, "patch" %>
          <div class="form-group">
            <label for="delegated_approver_id">Delegated Approver *</label>
            <select id="delegated_approver_id"
                    name="delegated_approver_id"
                    class="form-control"
                    required
                    data-parking-approve-modal-target="select">
              <option value="">-- Select Employee --</option>
            </select>
            <small class="help-text text-muted">This person will receive the request for final approval before it goes to Security.</small>
          </div>
          <div class="deny-modal__actions">
            <button type="button" class="btn" data-action="parking-approve-modal#close">Cancel</button>
            <button type="submit" class="btn approve">Approve & Send</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Existing Approve Modal for Probation Transfers -->
  <div id="approve-modal-backdrop"
       class="deny-modal-backdrop"
       data-approve-modal-target="backdrop"
       style="display:none;">
    <div class="deny-modal" role="dialog" aria-modal="true" data-approve-modal-target="modal">
      <div class="deny-modal__header">
        <h3 id="approve-modal-title" data-approve-modal-target="title">Approve</h3>
        <button type="button" class="deny-modal__close" data-action="approve-modal#close" aria-label="Close">✕</button>
      </div>
      <div class="deny-modal__body">
        <form data-approve-modal-target="form" method="post" action="#">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :_method, "patch" %>
          <div class="form-group">
            <label for="approved_destination">Select approved destination</label>
            <select id="approved_destination"
                    name="approved_destination"
                    class="form-control"
                    required
                    data-approve-modal-target="select">
            </select>
          </div>
          <div class="deny-modal__actions">
            <button type="button" class="btn" data-action="approve-modal#close">Cancel</button>
            <button type="submit" class="btn approve">Approve</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <%= render "shared/deny_modal" %>
</turbo-frame>
