<!-- app/views/inbox/queue.html.erb -->
<div class="inbox-page-wrapper" data-controller="task-selection approve-modal deny-modal reassign-modal">
  <h1 class="page-title">Inbox Queue</h1>

  <!-- Filter Form -->
  <div class="filter-wrapper">
    <form action="<%= inbox_queue_path %>" method="get" class="filter-form" data-controller="auto-submit" data-turbo="false">
      <div class="filter-controls">
        <div class="filter-group">
          <label for="filter_form_type">Form Type</label>
          <%= select_tag :filter_form_type,
              options_for_select([['All', '']] + @filter_options[:form_types].map { |ft| [ft, ft] }, params[:filter_form_type]),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_name">Name</label>
          <%= select_tag :filter_name,
              options_for_select([['All', '']] + @filter_options[:names].map { |n| [n, n] }, params[:filter_name]),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_unit">Unit</label>
          <%= select_tag :filter_unit,
              options_for_select([['All', '']] + @filter_options[:units].map { |u| [u, u] }, params[:filter_unit]),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_email">Email</label>
          <%= select_tag :filter_email,
              options_for_select([['All', '']] + @filter_options[:emails].map { |e| [e, e] }, params[:filter_email]),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_status">Status</label>
          <%= select_tag :filter_status,
              options_for_select([['All', '']] + @filter_options[:statuses].map { |s| [s, s] }, params[:filter_status]),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_date_from">Created From</label>
          <%= date_field_tag :filter_date_from, params[:filter_date_from],
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_date_to">Created To</label>
          <%= date_field_tag :filter_date_to, params[:filter_date_to],
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <% if params[:filter_form_type].present? || params[:filter_name].present? || params[:filter_unit].present? || params[:filter_email].present? || params[:filter_status].present? || params[:filter_date_from].present? || params[:filter_date_to].present? %>
          <%= link_to "Clear Filters", inbox_queue_path(sort_by: params[:sort_by], sort_direction: params[:sort_direction]), class: 'btn clear-filters', data: { turbo: false } %>
        <% end %>
      </div>

      <!-- Hidden fields to preserve sorting when filtering -->
      <%= hidden_field_tag :sort_by, params[:sort_by] %>
      <%= hidden_field_tag :sort_direction, params[:sort_direction] %>
    </form>
  </div>

  <!-- Action Panel (shown when a task is selected) -->
  <div class="action-panel" data-task-selection-target="actionPanel" style="display: none;">
    <div class="action-panel-content" data-task-selection-target="actionsContainer">
      <% if @submissions.present? %>
        <% @submissions.each do |submission| %>
          <div class="task-actions"
               data-task-type="<%= submission.class.name %>"
               data-task-id="<%= submission.id %>"
               style="display: none;">

            <div class="action-panel-label">
              <span class="label-form-type"><%= submission.class.name.demodulize.titleize %></span>
              <span class="label-name"><%= submission.name %></span>
            </div>

            <% if dynamic_form?(submission) %>
              <!-- DYNAMIC FORM BUTTONS (based on form template configuration) -->
              <%= render 'inbox/dynamic_buttons', submission: submission %>

              <button type="button" class="btn close-panel" data-action="click->task-selection#closePanel">
                Close
              </button>
            <% else %>
              <!-- HARDCODED FORM BUTTONS -->

              <!-- VIEW/DOWNLOAD ACTIONS -->
              <% if submission.is_a?(CriticalInformationReporting) %>
                <%= link_to "View PDF",
                    pdf_critical_information_reporting_path(submission),
                    class: "btn pdf",
                    data: { turbo: false } %>

                <% if submission.media.attached? %>
                  <%= link_to "Media",
                      download_media_critical_information_reporting_path(submission),
                      class: "btn pdf",
                      data: { turbo: false } %>
                <% end %>
              <% else %>
                <%= link_to "View PDF",
                    submission.is_a?(ParkingLotSubmission) ? pdf_parking_lot_submission_path(submission) : pdf_probation_transfer_request_path(submission),
                    target: "_blank",
                    class: "btn pdf" %>
              <% end %>

              <!-- EDIT/STATUS ACTIONS (CIR only) -->
              <% if submission.is_a?(CriticalInformationReporting) %>
                <%= link_to "Edit",
                    edit_critical_information_reporting_path(submission),
                    class: "btn edit",
                    data: { turbo: false } %>

                <%= form_with url: update_status_critical_information_reporting_path(submission),
                              method: :patch,
                              data: { turbo: false, controller: "auto-submit" } do |f| %>
                  <%= f.select :status,
                      options_for_select([
                        ['In Progress', 'in_progress'],
                        ['Resolved', 'resolved'],
                        ['Scheduled', 'scheduled'],
                        ['Cancelled', 'cancelled']
                      ], submission.status),
                      {},
                      class: "status-dropdown",
                      data: { action: "change->auto-submit#submit" } %>
                <% end %>
              <% end %>

              <!-- DECISION ACTIONS (Parking/Probation) -->
              <% if submission.is_a?(ParkingLotSubmission) || submission.is_a?(ProbationTransferRequest) %>
                <% if submission.is_a?(ParkingLotSubmission) %>
                  <%= button_to "Approve",
                        polymorphic_path(submission, action: :approve),
                        method: :patch,
                        class: "btn approve" %>

                <% elsif submission.is_a?(ProbationTransferRequest) %>
                  <button type="button"
                          class="btn approve"
                          data-action="click->approve-modal#open"
                          data-approve-modal-approve-path-value="<%= polymorphic_path(submission, action: :approve) %>"
                          data-approve-modal-options-value="<%= submission.desired_destinations_array.to_json %>"
                          data-approve-modal-title-value="<%= "Approve Transfer ##{submission.id}" %>">
                    Approve
                  </button>
                <% end %>

                <button type="button"
                        class="btn deny"
                        data-action="click->deny-modal#open"
                        data-deny-path="<%= polymorphic_path(submission, action: :deny) %>"
                        data-record-title="<%= "#{submission.class.name.demodulize.titleize} ##{submission.id}" %>">
                  Deny
                </button>
              <% end %>

              <!-- ASSIGNMENT ACTIONS (all forms) -->
              <button type="button"
                      class="btn reassign"
                      data-action="click->reassign-modal#open"
                      data-task-type="<%= submission.class.name %>"
                      data-task-id="<%= submission.id %>"
                      data-current-assignee="<%= submission.respond_to?(:current_assignee_id) ? submission.current_assignee_id : '' %>">
                Reassign
              </button>

              <% if submission.respond_to?(:can_take_back?) && submission.can_take_back?(session.dig(:user, "employee_id")) %>
                <%= button_to "Take Back",
                      take_back_task_reassignments_path,
                      method: :post,
                      params: {
                        task_type: submission.class.name,
                        task_id: submission.id,
                        to_employee_id: session.dig(:user, "employee_id")
                      },
                      class: "btn take-back",
                      form: { data: { turbo: false } } %>
              <% end %>

              <button type="button" class="btn close-panel" data-action="click->task-selection#closePanel">
                Close
              </button>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="submission-table">
      <thead>
        <tr>
          <th>
            <%= link_to inbox_queue_path(sort_by: 'form_type', sort_direction: params[:sort_by] == 'form_type' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_form_type: params[:filter_form_type], filter_name: params[:filter_name], filter_unit: params[:filter_unit], filter_email: params[:filter_email], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to]), class: 'sortable-header', data: { turbo: false } do %>
              Form Type
              <% if params[:sort_by] == 'form_type' %>
                <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
              <% end %>
            <% end %>
          </th>
          <th>
            <%= link_to inbox_queue_path(sort_by: 'name', sort_direction: params[:sort_by] == 'name' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_form_type: params[:filter_form_type], filter_name: params[:filter_name], filter_unit: params[:filter_unit], filter_email: params[:filter_email], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to]), class: 'sortable-header', data: { turbo: false } do %>
              Name
              <% if params[:sort_by] == 'name' %>
                <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
              <% end %>
            <% end %>
          </th>
          <th>
            <%= link_to inbox_queue_path(sort_by: 'unit', sort_direction: params[:sort_by] == 'unit' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_form_type: params[:filter_form_type], filter_name: params[:filter_name], filter_unit: params[:filter_unit], filter_email: params[:filter_email], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to]), class: 'sortable-header', data: { turbo: false } do %>
              Unit
              <% if params[:sort_by] == 'unit' %>
                <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
              <% end %>
            <% end %>
          </th>
          <th>
            <%= link_to inbox_queue_path(sort_by: 'email', sort_direction: params[:sort_by] == 'email' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_form_type: params[:filter_form_type], filter_name: params[:filter_name], filter_unit: params[:filter_unit], filter_email: params[:filter_email], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to]), class: 'sortable-header', data: { turbo: false } do %>
              Email
              <% if params[:sort_by] == 'email' %>
                <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
              <% end %>
            <% end %>
          </th>
          <th>
            <%= link_to inbox_queue_path(sort_by: 'status', sort_direction: params[:sort_by] == 'status' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_form_type: params[:filter_form_type], filter_name: params[:filter_name], filter_unit: params[:filter_unit], filter_email: params[:filter_email], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to]), class: 'sortable-header', data: { turbo: false } do %>
              Status
              <% if params[:sort_by] == 'status' %>
                <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
              <% end %>
            <% end %>
          </th>
          <th>
            <%= link_to inbox_queue_path(sort_by: 'created_at', sort_direction: params[:sort_by] == 'created_at' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_form_type: params[:filter_form_type], filter_name: params[:filter_name], filter_unit: params[:filter_unit], filter_email: params[:filter_email], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to]), class: 'sortable-header', data: { turbo: false } do %>
              Created
              <% if params[:sort_by] == 'created_at' || params[:sort_by].nil? %>
                <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
              <% end %>
            <% end %>
          </th>
        </tr>
      </thead>
      <tbody>
        <% if @submissions.present? %>
          <% @submissions.each do |submission| %>
            <tr class="selectable-row"
                data-task-selection-target="row"
                data-task-type="<%= submission.class.name %>"
                data-task-id="<%= submission.id %>"
                data-action="click->task-selection#select">
              <td><%= submission.class.name.demodulize.titleize %></td>
              <td><%= submission.name %></td>
              <td><%= submission.try(:unit) || "—" %></td>
              <td><%= submission.email %></td>
              <td>
                <span class="badge <%= status_badge_class(submission.status_label) %>">
                  <%= submission.status_label.to_s.tr('_', ' ').titleize %>
                </span>
              </td>
              <td><%= submission.created_at.strftime("%b %d, %Y") %></td>
            </tr>
          <% end %>
        <% else %>
          <tr><td colspan="6">No submissions found.</td></tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Approve Modal for Probation Transfers -->
  <div id="approve-modal-backdrop"
       class="deny-modal-backdrop"
       data-approve-modal-target="backdrop"
       style="display:none;">
    <div class="deny-modal" role="dialog" aria-modal="true" data-approve-modal-target="modal">
      <div class="deny-modal__header">
        <h3 id="approve-modal-title" data-approve-modal-target="title">Approve</h3>
        <button type="button" class="deny-modal__close" data-action="approve-modal#close" aria-label="Close">✕</button>
      </div>
      <div class="deny-modal__body">
        <form data-approve-modal-target="form" method="post" action="#">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= hidden_field_tag :_method, "patch" %>
          <div class="form-group">
            <label for="approved_destination">Select approved destination</label>
            <select id="approved_destination"
                    name="approved_destination"
                    class="form-control"
                    required
                    data-approve-modal-target="select">
            </select>
          </div>
          <div class="deny-modal__actions">
            <button type="button" class="btn" data-action="approve-modal#close">Cancel</button>
            <button type="submit" class="btn approve">Approve</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <%= render "shared/deny_modal" %>
  <%= render "shared/reassign_modal" %>
</div>
