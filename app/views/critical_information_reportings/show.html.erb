<!-- app/views/critical_information_reportings/show.html.erb -->

<div class="form-header">
  <h1>Critical Information Report #<%= @critical_information_reporting.id %></h1>
</div>

<div class="form-wrapper">
  <div class="form-inner">

    <!-- Current Status Banner -->
    <div class="status-banner <%= "status-#{@critical_information_reporting.status_category}" %>">
      <strong>Status:</strong> <%= @critical_information_reporting.status_label %>
      <span class="status-date">| Submitted <%= l(@critical_information_reporting.created_at, format: :short) %></span>
    </div>

    <!-- Incident Summary - Top Priority Info -->
    <section class="incident-hero">
      <div class="incident-type-banner">
        <%= @critical_information_reporting.incident_type %>
      </div>

      <div class="incident-meta">
        <div class="meta-item">
          <span class="meta-label">Location</span>
          <span class="meta-value"><%= @critical_information_reporting.location %></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Urgency</span>
          <span class="meta-value urgency"><%= @critical_information_reporting.urgency %></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Impact</span>
          <span class="impact-badge impact-<%= @critical_information_reporting.impact&.downcase %>">
            <%= @critical_information_reporting.impact %>
          </span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Impact Started</span>
          <span class="meta-value"><%= @critical_information_reporting.impact_started.present? ? l(@critical_information_reporting.impact_started, format: :short) : "Not specified" %></span>
        </div>
      </div>

      <div class="incident-description">
        <strong>What Happened:</strong>
        <p><%= @critical_information_reporting.incident_details %></p>
      </div>

      <div class="incident-cause">
        <strong>Cause:</strong>
        <p><%= @critical_information_reporting.cause %></p>
      </div>

      <% if @critical_information_reporting.next_steps.present? %>
        <div class="incident-next-steps">
          <strong>Next Steps:</strong>
          <p><%= @critical_information_reporting.next_steps %></p>
        </div>
      <% end %>
    </section>

    <!-- Quick Info Grid -->
    <section class="info-grid">
      <div class="info-card">
        <h3>Reported By</h3>
        <p class="primary"><%= @critical_information_reporting.name %></p>
        <p class="secondary"><%= @critical_information_reporting.phone %> | <%= @critical_information_reporting.email %></p>
      </div>

      <div class="info-card">
        <h3>Organization</h3>
        <p class="primary"><%= Agency.find_by(agency_id: @critical_information_reporting.agency)&.long_name || @critical_information_reporting.agency %></p>
        <p class="secondary">
          <%= Division.find_by(division_id: @critical_information_reporting.division)&.long_name || @critical_information_reporting.division %>
        </p>
      </div>

      <div class="info-card">
        <h3>Assigned To</h3>
        <p class="primary"><%= @critical_information_reporting.assigned_manager_name %></p>
      </div>

      <div class="info-card">
        <h3>Impacted Customers</h3>
        <p class="primary"><%= @critical_information_reporting.impacted_customers %></p>
      </div>
    </section>

    <!-- Staff Involved -->
    <% staff_ids = @critical_information_reporting.staff_involved.to_s.split(",").map(&:strip).reject(&:blank?) %>
    <% if staff_ids.any? %>
      <section class="staff-section">
        <h3>Staff Involved</h3>
        <div class="staff-chips">
          <% staff_ids.each do |staff_id| %>
            <% employee = Employee.find_by(EmployeeID: staff_id) %>
            <span class="staff-chip">
              <% if employee %>
                <%= employee["First_Name"] %> <%= employee["Last_Name"] %>
              <% else %>
                ID: <%= staff_id %>
              <% end %>
            </span>
          <% end %>
        </div>
      </section>
    <% end %>

    <!-- Media Attachment -->
    <% if @critical_information_reporting.media.attached? %>
      <section class="media-section">
        <h3>Attached Media</h3>
        <div class="media-attachment">
          <% if @critical_information_reporting.media.content_type.start_with?("image/") %>
            <%= image_tag rails_blob_path(@critical_information_reporting.media), class: "attached-image", alt: "Attached media" %>
          <% end %>
          <p><%= @critical_information_reporting.media.filename %> (<%= number_to_human_size(@critical_information_reporting.media.byte_size) %>)</p>
          <%= link_to "Download", download_media_critical_information_reporting_path(@critical_information_reporting), class: "btn-link" %>
        </div>
      </section>
    <% end %>

    <!-- Status History (Collapsible) -->
    <details class="audit-section">
      <summary><h3>Status History & Audit Trail</h3></summary>
      <% if @status_changes.any? %>
        <table class="audit-table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Status</th>
              <th>Changed By</th>
            </tr>
          </thead>
          <tbody>
            <% @status_changes.each do |change| %>
              <tr>
                <td><%= l(change.created_at, format: :long) %></td>
                <td>
                  <% if change.from_status.present? %>
                    <span class="from-status"><%= change.from_status.humanize %></span> &rarr;
                  <% end %>
                  <strong><%= change.to_status.humanize %></strong>
                </td>
                <td><%= change.changed_by_name.presence || "System" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="no-history">No status history available.</p>
      <% end %>
    </details>

    <!-- Action Buttons -->
    <div class="form-actions">
      <%= link_to "Back to Status", status_path, class: "form-btn" %>
      <%= link_to "Download PDF", pdf_critical_information_reporting_path(@critical_information_reporting), target: "_blank", class: "form-btn" %>
      <%= link_to "Edit Report", edit_critical_information_reporting_path(@critical_information_reporting), class: "form-btn" %>
    </div>

  </div>
</div>

<style>
  .status-banner {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .status-banner .status-date {
    font-size: 0.85em;
    opacity: 0.8;
  }
  .status-banner.status-in_review {
    background-color: #fff3cd;
    border: 1px solid #ffc107;
    color: #856404;
  }
  .status-banner.status-approved {
    background-color: #d4edda;
    border: 1px solid #28a745;
    color: #155724;
  }
  .status-banner.status-cancelled {
    background-color: #f8d7da;
    border: 1px solid #dc3545;
    color: #721c24;
  }
  .status-banner.status-scheduled {
    background-color: #cce5ff;
    border: 1px solid #004085;
    color: #004085;
  }

  /* Incident Hero Section */
  .incident-hero {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
  }
  .incident-type-banner {
    font-size: 1.5em;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #dc3545;
  }
  .incident-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }
  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .meta-label {
    font-size: 0.75em;
    text-transform: uppercase;
    color: #666;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .meta-value {
    font-size: 0.95em;
    color: #333;
  }
  .meta-value.urgency {
    font-weight: 600;
    color: #c00;
  }

  .incident-description,
  .incident-cause,
  .incident-next-steps {
    margin-bottom: 12px;
  }
  .incident-description strong,
  .incident-cause strong,
  .incident-next-steps strong {
    display: block;
    font-size: 0.85em;
    color: #555;
    margin-bottom: 4px;
  }
  .incident-description p,
  .incident-cause p,
  .incident-next-steps p {
    margin: 0;
    line-height: 1.5;
    color: #333;
  }

  /* Impact Badge */
  .impact-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8em;
  }
  .impact-badge.impact-low {
    background-color: #d4edda;
    color: #155724;
  }
  .impact-badge.impact-medium {
    background-color: #fff3cd;
    color: #856404;
  }
  .impact-badge.impact-high {
    background-color: #f8d7da;
    color: #721c24;
  }

  /* Info Grid */
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .info-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 14px;
  }
  .info-card h3 {
    font-size: 0.75em;
    text-transform: uppercase;
    color: #666;
    margin: 0 0 8px 0;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .info-card .primary {
    font-size: 1em;
    font-weight: 600;
    color: #333;
    margin: 0;
  }
  .info-card .secondary {
    font-size: 0.85em;
    color: #666;
    margin: 4px 0 0 0;
  }

  /* Staff Section */
  .staff-section {
    margin-bottom: 24px;
  }
  .staff-section h3 {
    font-size: 0.85em;
    text-transform: uppercase;
    color: #666;
    margin: 0 0 10px 0;
    font-weight: 600;
  }
  .staff-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .staff-chip {
    background: #e9ecef;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 0.9em;
    color: #333;
  }

  /* Media Section */
  .media-section {
    margin-bottom: 24px;
  }
  .media-section h3 {
    font-size: 0.85em;
    text-transform: uppercase;
    color: #666;
    margin: 0 0 10px 0;
    font-weight: 600;
  }
  .media-attachment {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    display: inline-block;
  }
  .attached-image {
    max-width: 300px;
    max-height: 200px;
    display: block;
    margin-bottom: 8px;
    border-radius: 4px;
  }
  .media-attachment p {
    margin: 0 0 6px 0;
    font-size: 0.9em;
    color: #666;
  }
  .btn-link {
    color: #007bff;
    text-decoration: none;
    font-size: 0.9em;
  }
  .btn-link:hover {
    text-decoration: underline;
  }

  /* Audit Section */
  .audit-section {
    margin-bottom: 24px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
  }
  .audit-section summary {
    padding: 12px 16px;
    cursor: pointer;
    background: #f8f9fa;
    border-radius: 6px;
  }
  .audit-section summary h3 {
    display: inline;
    font-size: 0.95em;
    color: #333;
    margin: 0;
  }
  .audit-section[open] summary {
    border-bottom: 1px solid #e0e0e0;
    border-radius: 6px 6px 0 0;
  }
  .audit-table {
    width: 100%;
    font-size: 0.9em;
    border-collapse: collapse;
  }
  .audit-table th {
    text-align: left;
    padding: 10px 12px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    font-weight: 600;
    color: #555;
  }
  .audit-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
  }
  .audit-table tr:last-child td {
    border-bottom: none;
  }
  .from-status {
    color: #888;
  }
  .no-history {
    padding: 16px;
    color: #888;
    font-style: italic;
  }

  /* Action Buttons */
  .form-actions {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
</style>
