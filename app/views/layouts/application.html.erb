<!DOCTYPE html>
<html>
  <head>
    <title>FormsApp</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", media: "all", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <!-- Choices.js Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  </head>

 <body>
  <div class="app-container">
    <%= render "shared/sidebar" %>

    <div class="content-container">
      <div id="main-content">
        <% if content_for?(:image) %>
          <%= yield :image %>
        <% else %>
          <%= yield %>
        <% end %>

        <!-- Login Button (over image) -->
        <% unless session[:user] %>
          <button id="login-btn" class="login-button-over-image">Login</button>
        <% else %>
          <div class="profile-dropdown" id="profile-dropdown">
          <button id="profile-toggle" class="profile-icon">
            <%= session[:user]["first_name"] %>
            <% if inbox_count > 0 %>
              <span class="inbox-badge"><%= inbox_count %></span>
            <% end %>
          </button>
          <div class="dropdown-content" id="dropdown-content">
           <%= link_to "Inbox Queue", parking_lot_submissions_path %>
            <%= button_to "Logout", logout_path, method: :delete, class: "logout-btn" %>
          </div>
        </div>
        <% end %>

        <!-- Login Modal -->
       <div id="login-modal" class="modal">
          <div class="modal-content">
            <span id="close-modal" class="close">&times;</span>
            <h2>Login</h2>
            <form id="login-form">
              <input type="text" name="login" placeholder="Employee ID or Email" required>
              <button type="submit">Log in</button>
            </form>
          </div>
        </div>
 
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Login modal logic
    const loginBtn = document.getElementById("login-btn");
    const modal = document.getElementById("login-modal");
    const closeModal = document.getElementById("close-modal");

    if (loginBtn && modal) {
      loginBtn.addEventListener("click", () => modal.style.display = "block");
    }

    if (closeModal && modal) {
      closeModal.addEventListener("click", () => modal.style.display = "none");
    }

    document.getElementById("login-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const login = e.target.login.value;
      const res = await fetch("/login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ login })
      });

      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert("Login failed.");
      }
    });

    // Profile dropdown toggle
    const profileToggle = document.getElementById("profile-toggle");
    const dropdown = document.getElementById("dropdown-content");

    if (profileToggle && dropdown) {
      profileToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("show");
      });

      document.addEventListener("click", () => {
        dropdown.classList.remove("show");
      });

      dropdown.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    }
  });
</script>
<!-- Choices.js Script -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</body> 
</html>
