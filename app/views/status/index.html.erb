<!-- app/views/status/index.html.erb -->
<div class="form-header">
  <h1>Status</h1>
</div>

<!-- Filter Form -->
<div data-controller="status-filters"
     data-status-filters-status-options-value='<%= @status_options_by_type.to_json %>'
     data-status-filters-all-statuses-value='<%= @filter_options[:statuses].to_json %>'
     data-status-filters-title-options-value='<%= @title_options_by_type.to_json %>'
     data-status-filters-all-titles-value='<%= @filter_options[:titles].to_json %>'>
<div class="filter-wrapper" data-controller="saved-search">
  <!-- Hidden delete form (outside the GET filter form to avoid nesting) -->
  <form data-saved-search-target="deleteForm" method="post" style="display: none;">
    <input type="hidden" name="_method" value="delete">
    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
  </form>

  <form action="<%= status_path %>" method="get" class="filter-form" data-controller="auto-submit" data-turbo="false">
    <div class="filter-controls">
      <div class="filter-group">
        <label for="filter_type">Type</label>
        <%= select_tag :filter_type,
            options_for_select([['All', '']] + @filter_options[:types].map { |t| [t, t] }, params[:filter_type]),
            class: 'filter-select',
            data: {
              status_filters_target: "type",
              action: "change->status-filters#typeChanged change->auto-submit#submit"
            } %>
      </div>

      <div class="filter-group">
        <label for="filter_title">Title</label>
        <%= select_tag :filter_title,
            options_for_select([['All', '']] + @filter_options[:titles].map { |t| [t, t] }, params[:filter_title]),
            class: 'filter-select',
            data: {
              status_filters_target: "title",
              action: "change->auto-submit#submit"
            } %>
      </div>

      <div class="filter-group">
        <label for="filter_category">Category</label>
        <%= select_tag :filter_category,
            options_for_select([['All', '']] + @filter_options[:categories].map { |c| [c, c] }, params[:filter_category]),
            class: 'filter-select',
            data: { action: "change->auto-submit#submit" } %>
      </div>

      <div class="filter-group">
        <label for="filter_status">Status</label>
        <%= select_tag :filter_status,
            options_for_select([['All', '']] + @filter_options[:statuses].map { |s| [s, s] }, params[:filter_status]),
            class: 'filter-select',
            data: {
              status_filters_target: "status",
              action: "change->auto-submit#submit"
            } %>
      </div>

      <% if @is_manager && @employees.present? %>
        <div class="filter-group">
          <label for="filter_employee_name">Employee</label>
          <%= select_tag :filter_employee_name,
              options_for_select(
                [['All', ''], ["#{session.dig(:user, 'last_name')}, #{session.dig(:user, 'first_name')} (Me)", @current_user_name]] + @employees.map { |e| ["#{e.Last_Name}, #{e.First_Name}", "#{e.First_Name} #{e.Last_Name}"] },
                params[:filter_employee_name]
              ),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>

        <div class="filter-group">
          <label for="filter_employee_id">Employee ID</label>
          <%= select_tag :filter_employee_id,
              options_for_select(
                [['All', ''], ["#{@current_user_id} (Me)", @current_user_id]] + @employees.map { |e| [e.EmployeeID.to_s, e.EmployeeID.to_s] },
                params[:filter_employee_id]
              ),
              class: 'filter-select',
              data: { action: "change->auto-submit#submit" } %>
        </div>
      <% end %>

      <div class="filter-group">
        <label for="filter_date_from">Submitted From</label>
        <%= date_field_tag :filter_date_from, params[:filter_date_from],
            class: 'filter-select',
            data: { action: "change->auto-submit#submit" } %>
      </div>

      <div class="filter-group">
        <label for="filter_date_to">Submitted To</label>
        <%= date_field_tag :filter_date_to, params[:filter_date_to],
            class: 'filter-select',
            data: { action: "change->auto-submit#submit" } %>
      </div>

      <% has_filters = params[:filter_type].present? || params[:filter_title].present? || params[:filter_category].present? || params[:filter_status].present? || params[:filter_date_from].present? || params[:filter_date_to].present? || params[:filter_employee_name].present? || params[:filter_employee_id].present? %>
      <% if has_filters %>
        <%= link_to "Clear Filters", status_path(sort_by: params[:sort_by], sort_direction: params[:sort_direction]), class: 'btn clear-filters', data: { turbo: false } %>
      <% end %>
    </div>

    <!-- Hidden fields to preserve sorting when filtering -->
    <%= hidden_field_tag :sort_by, params[:sort_by] %>
    <%= hidden_field_tag :sort_direction, params[:sort_direction] %>

    <div class="saved-search-bar">
      <div class="saved-search-controls">
        <select class="filter-select" data-saved-search-target="dropdown" data-action="change->saved-search#load">
          <option value="">Saved Searches</option>
          <% @saved_searches.each do |ss| %>
            <option value="<%= ss.id %>"
                    data-filters="<%= ss.filters.to_json %>"
                    <%= 'selected' if params[:saved_search_id].to_s == ss.id.to_s %>>
              <%= ss.name %>
            </option>
          <% end %>
        </select>

        <button type="button" class="btn" data-action="click->saved-search#toggleSaveForm">Save Search</button>
        <button type="button" class="btn deny" data-action="click->saved-search#confirmDelete">Delete</button>
      </div>

      <div class="saved-search-save-form" data-saved-search-target="saveForm" style="display: none;">
        <input type="text" class="filter-select" placeholder="Search name..." data-saved-search-target="nameInput"
               data-action="keydown.enter->saved-search#save">
        <button type="button" class="btn approve" data-action="click->saved-search#save">Confirm</button>
      </div>
    </div>
  </form>
</div>

<div class="form-wrapper status-wrapper">
<table class="status-table">
  <thead>
    <tr>
      <th>
        <%= link_to status_path(sort_by: 'type', sort_direction: params[:sort_by] == 'type' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
          Type
          <% if params[:sort_by] == 'type' %>
            <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
          <% end %>
        <% end %>
      </th>
      <th>
        <%= link_to status_path(sort_by: 'title', sort_direction: params[:sort_by] == 'title' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
          Title
          <% if params[:sort_by] == 'title' %>
            <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
          <% end %>
        <% end %>
      </th>
      <% if @is_manager %>
        <th>
          <%= link_to status_path(sort_by: 'employee_name', sort_direction: params[:sort_by] == 'employee_name' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
            Employee
            <% if params[:sort_by] == 'employee_name' %>
              <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
            <% end %>
          <% end %>
        </th>
        <th>
          <%= link_to status_path(sort_by: 'employee_id', sort_direction: params[:sort_by] == 'employee_id' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
            Employee ID
            <% if params[:sort_by] == 'employee_id' %>
              <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
            <% end %>
          <% end %>
        </th>
      <% end %>
      <th>
        <%= link_to status_path(sort_by: 'status', sort_direction: params[:sort_by] == 'status' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
          Status
          <% if params[:sort_by] == 'status' %>
            <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
          <% end %>
        <% end %>
      </th>
      <th>
        <%= link_to status_path(sort_by: 'submitted_at', sort_direction: params[:sort_by] == 'submitted_at' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
          Submitted
          <% if params[:sort_by] == 'submitted_at' %>
            <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
          <% end %>
        <% end %>
      </th>
      <th>
        <%= link_to status_path(sort_by: 'updated_at', sort_direction: params[:sort_by] == 'updated_at' && params[:sort_direction] == 'asc' ? 'desc' : 'asc', filter_type: params[:filter_type], filter_title: params[:filter_title], filter_category: params[:filter_category], filter_status: params[:filter_status], filter_date_from: params[:filter_date_from], filter_date_to: params[:filter_date_to], filter_employee_name: params[:filter_employee_name], filter_employee_id: params[:filter_employee_id]), class: 'sortable-header', data: { turbo: false } do %>
          Last Updated
          <% if params[:sort_by] == 'updated_at' || params[:sort_by].nil? %>
            <span class="sort-indicator"><%= params[:sort_direction] == 'asc' ? '▲' : '▼' %></span>
          <% end %>
        <% end %>
      </th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <% if @status_items.present? %>
      <% @status_items.each do |item| %>
        <tr class="status-row">
          <td class="col-type"><%= item[:type] %></td>
          <td class="col-title"><%= item[:title] %></td>
          <% if @is_manager %>
            <td class="col-employee-name"><%= item[:employee_name] %></td>
            <td class="col-employee-id"><%= item[:employee_id] %></td>
          <% end %>
          <td class="col-status">
            <span class="badge <%= category_badge_class(item[:status_category]) %>">
              <%= item[:status].to_s.tr('_', ' ') %>
            </span>
          </td>
          <td class="col-submitted"><%= format_pst(item[:submitted_at]) %></td>
          <td class="col-updated"><%= format_pst(item[:updated_at]) %></td>
          <td class="col-actions"><%= link_to "Open", item[:path], class: "btn" %></td>
        </tr>
      <% end %>
    <% else %>
      <tr><td colspan="<%= @is_manager ? 9 : 7 %>">No submissions found.</td></tr>
    <% end %>
  </tbody>
</table>
</div>
</div>
